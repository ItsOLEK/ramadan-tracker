<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مبادرة مأوَى - ختمة القرآن الكريم</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .quran-font { font-family: 'Amiri', serif; }
    .onboarding-screen { display:none }
    .onboarding-screen.active { display:flex }
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:200; align-items:center; justify-content:center }
    .modal-overlay.active { display:flex }
    .progress-fill { transition: width .6s ease }
  </style>
</head>

<body class="bg-gray-50">

<!-- ====================== الواجهة (كما هي) ====================== -->
<div id="onboarding" class="fixed inset-0 bg-emerald-900 text-white flex">
  <div id="step-1" class="onboarding-screen active flex-col m-auto text-center gap-6">
    <h1 class="text-4xl font-bold text-yellow-400">مبادرة مأوَى</h1>
    <p class="quran-font text-xl">﴿إِنَّ هَذَا الْقُرْآنَ يَهْدِي لِلَّتِي هِيَ أَقْوَمُ﴾</p>
    <button onclick="nextStep(2)" class="bg-yellow-400 text-emerald-900 px-8 py-3 rounded-full font-bold">ابدأ الآن</button>
  </div>

  <div id="step-2" class="onboarding-screen flex-col m-auto gap-4 w-72">
    <input id="user-name" placeholder="الاسم الثلاثي" class="p-3 rounded text-black">
    <input id="user-age" type="number" placeholder="العمر" class="p-3 rounded text-black">
    <input id="user-phone" placeholder="رقم الهاتف" class="p-3 rounded text-black">
    <div class="flex gap-2">
      <button onclick="setGender('ذكر')" id="gender-male" class="flex-1 bg-white/20 p-2 rounded">ذكر</button>
      <button onclick="setGender('أنثى')" id="gender-female" class="flex-1 bg-white/20 p-2 rounded">أنثى</button>
    </div>
    <button onclick="validateAndNext(3)" class="bg-white text-emerald-900 p-3 rounded font-bold">التالي</button>
  </div>

  <div id="step-3" class="onboarding-screen flex-col m-auto gap-4">
    <h2 class="text-xl font-bold">جاهز تبدأ؟</h2>
    <button onclick="completeOnboarding(false)" class="bg-yellow-400 text-emerald-900 p-3 rounded font-bold">ابدأ</button>
  </div>
</div>

<div id="app-content" style="display:none">
  <header class="bg-emerald-800 text-white p-4 text-center">
    <h2 id="display-name" class="font-bold"></h2>
    <div class="w-full bg-white/20 h-2 rounded mt-2">
      <div id="progress-bar" class="bg-yellow-400 h-2 rounded progress-fill" style="width:0%"></div>
    </div>
    <p id="progress-percentage" class="text-sm mt-1">0%</p>
  </header>

  <main class="p-4 text-center">
    <p id="pages-count-display">تم قراءة: 0 صفحة</p>
    <button onclick="toggleFakeProgress()" class="mt-4 bg-emerald-600 text-white px-4 py-2 rounded">
      اختبار التقدم
    </button>
  </main>
</div>

<!-- ====================== السكربت (Firebase + كودك) ====================== -->
<script type="module">

/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmzn1ZRonUVaR341VRhhXDe6L9xCYY36c",
  authDomain: "ramadan-tracker-df2a4.firebaseapp.com",
  projectId: "ramadan-tracker-df2a4",
  storageBucket: "ramadan-tracker-df2a4.firebasestorage.app",
  messagingSenderId: "647463916903",
  appId: "1:647463916903:web:59349a5822425c09ff8bc2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ========= بيانات التطبيق ========= */
const TOTAL_PAGES = 604;
let selectedGender = null;

let userData = JSON.parse(localStorage.getItem("ramadanUserData")) || null;
let userProgress = JSON.parse(localStorage.getItem("ramadanKhatmaProgress")) || {};

/* ========= Firebase helpers ========= */
function saveToFirebase() {
  if (!userData?.phone) return;
  set(ref(db, "users/" + userData.phone), {
    userData,
    userProgress,
    updatedAt: Date.now()
  });
}

async function loadFromFirebase() {
  if (!userData?.phone) return;
  const snap = await get(ref(db, "users/" + userData.phone));
  if (snap.exists()) {
    const data = snap.val();
    userData = data.userData;
    userProgress = data.userProgress || {};
    localStorage.setItem("ramadanUserData", JSON.stringify(userData));
    localStorage.setItem("ramadanKhatmaProgress", JSON.stringify(userProgress));
  }
}

/* ========= وظائف الواجهة ========= */
function nextStep(step) {
  document.querySelectorAll(".onboarding-screen").forEach(s => s.classList.remove("active"));
  document.getElementById("step-" + step).classList.add("active");
}

function setGender(g) {
  selectedGender = g;
}

function validateAndNext(step) {
  if (!user-name.value || !user-age.value || !user-phone.value || !selectedGender) return;
  nextStep(step);
}

function completeOnboarding() {
  userData = {
    name: document.getElementById("user-name").value,
    age: document.getElementById("user-age").value,
    phone: document.getElementById("user-phone").value,
    gender: selectedGender
  };
  localStorage.setItem("ramadanUserData", JSON.stringify(userData));
  saveToFirebase();
  startApp();
}

function startApp() {
  document.getElementById("onboarding").style.display = "none";
  document.getElementById("app-content").style.display = "block";
  document.getElementById("display-name").textContent = userData.name;
  updateStats();
}

function toggleFakeProgress() {
  userProgress.test = !userProgress.test;
  localStorage.setItem("ramadanKhatmaProgress", JSON.stringify(userProgress));
  saveToFirebase();
  updateStats();
}

function updateStats() {
  const pages = Object.keys(userProgress).length * 5;
  const pct = Math.min(100, Math.round((pages / TOTAL_PAGES) * 100));
  document.getElementById("progress-bar").style.width = pct + "%";
  document.getElementById("progress-percentage").textContent = pct + "%";
  document.getElementById("pages-count-display").textContent = `تم قراءة: ${pages} صفحة`;
}

/* ========= تشغيل ========= */
window.onload = async () => {
  if (userData) {
    await loadFromFirebase();
    startApp();
  }
};

</script>
</body>
</html>
